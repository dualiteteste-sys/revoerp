/*
# [SECURITY] Fix Function Search Path
[This script hardens the security of database functions by explicitly setting the `search_path`. This prevents potential security vulnerabilities where a malicious user could temporarily create objects (like tables or functions) in other schemas to intercept data or execute unauthorized code.]

## Query Description: [This operation modifies existing database functions to improve security. It is a safe, non-destructive change that does not affect your data. By setting a fixed `search_path`, we ensure that functions always look for tables and other objects in the correct schema (`public`), preventing potential hijacking attacks.]

## Metadata:
- Schema-Category: ["Security", "Structural"]
- Impact-Level: ["Low"]
- Requires-Backup: [false]
- Reversible: [true]

## Structure Details:
[
  - ALTER FUNCTION handle_new_user(),
  - ALTER FUNCTION get_faturamento_ultimos_12_meses(),
  - ALTER FUNCTION get_dashboard_stats(),
  - ALTER FUNCTION get_contratos_para_faturar(integer, integer),
  - ALTER FUNCTION get_visao_cobrancas(integer, integer),
  - ALTER FUNCTION update_estoque(),
  - ALTER FUNCTION log_estoque_movimento()
]

## Security Implications:
- RLS Status: [Not Applicable]
- Policy Changes: [No]
- Auth Requirements: [admin]
- Mitigates: [Search Path Hijacking (CVE-2018-1058)]

## Performance Impact:
- Indexes: [Not Applicable]
- Triggers: [Not Applicable]
- Estimated Impact: [None. This is a metadata change for security and has no performance overhead.]
*/

-- Fix for handle_new_user trigger function
ALTER FUNCTION public.handle_new_user()
SET search_path = 'public';

-- Fix for get_faturamento_ultimos_12_meses function
ALTER FUNCTION public.get_faturamento_ultimos_12_meses()
SET search_path = 'public';

-- Fix for get_dashboard_stats function
ALTER FUNCTION public.get_dashboard_stats()
SET search_path = 'public';

-- Fix for get_contratos_para_faturar function
ALTER FUNCTION public.get_contratos_para_faturar(p_ano integer, p_mes integer)
SET search_path = 'public';

-- Fix for get_visao_cobrancas function
ALTER FUNCTION public.get_visao_cobrancas(p_ano integer, p_mes integer)
SET search_path = 'public';

-- Fix for update_estoque trigger function
ALTER FUNCTION public.update_estoque()
SET search_path = 'public';

-- Fix for log_estoque_movimento trigger function
ALTER FUNCTION public.log_estoque_movimento()
SET search_path = 'public';
